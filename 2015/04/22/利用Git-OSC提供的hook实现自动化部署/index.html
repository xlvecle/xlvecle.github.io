<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>利用Git@OSC提供的hook实现自动化部署 | xlvecle&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="今天找了找免费的Git私有代码仓库，发现Git@OSC是个不错的选择，更让人惊喜的是提供了钩子(hook)，可以在每次push代码后，给远程HTTP URL发送一个POST请求，实在是自动部署的利器。">
<meta property="og:type" content="article">
<meta property="og:title" content="利用Git@OSC提供的hook实现自动化部署">
<meta property="og:url" content="http://xlvecle.github.io/2015/04/22/利用Git-OSC提供的hook实现自动化部署/index.html">
<meta property="og:site_name" content="xlvecle's blog">
<meta property="og:description" content="今天找了找免费的Git私有代码仓库，发现Git@OSC是个不错的选择，更让人惊喜的是提供了钩子(hook)，可以在每次push代码后，给远程HTTP URL发送一个POST请求，实在是自动部署的利器。">
<meta property="og:image" content="http://xlvecle.github.io/img/git_osc_hook.jpg">
<meta property="og:image" content="http://xlvecle.github.io/img/lsof-i.jpg">
<meta property="og:updated_time" content="2015-04-22T11:10:06.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="利用Git@OSC提供的hook实现自动化部署">
<meta name="twitter:description" content="今天找了找免费的Git私有代码仓库，发现Git@OSC是个不错的选择，更让人惊喜的是提供了钩子(hook)，可以在每次push代码后，给远程HTTP URL发送一个POST请求，实在是自动部署的利器。">
  
    <link rel="alternative" href="/atom.xml" title="xlvecle&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">xlvecle&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-home-icon" class="nav-icon" href="/"></a>
        
          <a id="nav-archives-icon" class="nav-icon" href="/archives"></a>
        
          <a id="nav-about-icon" class="nav-icon" href="/about"></a>
        
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-利用Git-OSC提供的hook实现自动化部署" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      利用Git@OSC提供的hook实现自动化部署
    </h1>
  

      </header>
    
    <time class="article-date" datetime="2015-04-22T08:47:43.000Z" itemprop="datePublished">04-22-2015</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天找了找免费的Git私有代码仓库，发现<a href="http://git.oschina.net/" target="_blank" rel="external">Git@OSC</a>是个不错的选择，更让人惊喜的是提供了钩子(hook)，可以在每次push代码后，给远程HTTP URL发送一个POST请求，实在是自动部署的利器。<a id="more"></a></p>
<blockquote>
<p>使用探究</p>
</blockquote>
<p>我在这里使用php来接收push请求，然后解析请求带来的json数据，取出需要的部分留着后面用。取出的数据包括钩子密码、commit信息以及project url等。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="variable">$hook_data</span> = json_decode(<span class="variable">$_REQUEST</span>[<span class="string">'hook'</span>]);</span><br><span class="line"><span class="variable">$req_time</span> = date(<span class="string">'Y-m-d-G:i:s'</span>, <span class="variable">$_SERVER</span>[<span class="string">'REQUEST_TIME'</span>]);</span><br><span class="line"><span class="variable">$passwd</span> = <span class="variable">$hook_data</span>-&gt;password;</span><br><span class="line"><span class="variable">$new_commit</span> = <span class="variable">$hook_data</span>-&gt;push_data-&gt;commits[count(<span class="variable">$hook_data</span>-&gt;push_data-&gt;commits)-<span class="number">1</span>];</span><br><span class="line"><span class="variable">$new_commit_msg</span> = <span class="variable">$new_commit</span>-&gt;message;</span><br><span class="line"><span class="variable">$project_name</span> = explode(<span class="string">'.'</span>,explode(<span class="string">'/'</span>,<span class="variable">$hook_data</span>-&gt;push_data-&gt;repository-&gt;url)[<span class="number">1</span>])[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后做一次判断，校验密码以及匹配是否为release版本。进入if之后，调用exec打一条log并执行一个shell脚本。在调用exec中遇到了许多问题，比如你可能会发现我在输出log时我没有使用重定向而用了指令tee，这些问题看起来细小但却很烦人，我会在后面提到这些问题的解决办法。我本来打算把脚本都用exec写在php文件中，但是在php中写shell实在很捉急，所以我选择把拉取代码，清理目录并发布的脚本都写在了另一个文件中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$passwd</span> == <span class="string">'passwd'</span> &amp;&amp; preg_match(<span class="string">'/release/'</span>, <span class="variable">$new_commit_msg</span>)) &#123;</span><br><span class="line">	exec(<span class="string">"sudo echo '"</span>.<span class="variable">$req_time</span>.<span class="string">"\ndeploy\n=====================================' |sudo tee -a "</span>.<span class="variable">$project_name</span>.<span class="string">"_deploy.log"</span>);</span><br><span class="line">	exec(<span class="string">"cd /var/www/html/"</span>.<span class="variable">$project_name</span>.<span class="string">"Deploy \n sudo ./oscAutoDeploy "</span>.<span class="variable">$project_url</span>.<span class="string">" "</span>.<span class="variable">$project_name</span>);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果判断没有通过，为了安全性，我在这里会返回一条警告信息并输出一条log。log信息中记录了请求的时间，IP以及UA，方便分析排查问题来源。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span>(<span class="string">"don't do this"</span>);</span><br><span class="line">exec(<span class="string">"sudo echo '"</span>.<span class="variable">$req_time</span>.<span class="string">"\na serious man try to deploy\nfrom "</span>.getIP().<span class="string">"\nua: "</span>.getallheaders()[<span class="string">'User-Agent'</span>].<span class="string">"\n=====================================' |sudo tee -a /var/logs/iudang/"</span>.<span class="variable">$project_name</span>.<span class="string">"_attack.log"</span>);</span><br></pre></td></tr></table></figure>
<p>上面获取用户IP我使用的是一种非常清晰的方法，和之前谈过的<a href="">使用php请求api</a>问题一样，搜索之后的答案五花八门，千奇百怪，大多丑且不忍直视，虽然我的这一段if else过多但是论清晰度论实效都是很不错的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIP</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getenv(<span class="string">"HTTP_CLIENT_IP"</span>))</span><br><span class="line">        <span class="variable">$ip</span> = getenv(<span class="string">"HTTP_CLIENT_IP"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>))</span><br><span class="line">        <span class="variable">$ip</span> = getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(getenv(<span class="string">"REMOTE_ADDR"</span>))</span><br><span class="line">        <span class="variable">$ip</span> = getenv(<span class="string">"REMOTE_ADDR"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="variable">$ip</span> = <span class="string">"Unknow"</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$ip</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在php文件写完之后，我们就开始写真正负责部署发布的shell脚本了。在上面我们传入了project_url和project_name两个参数，这里根据它们进行目录整理及克隆部署工作，因为php部署比较简单，所以工作量很小，如果要部署其他语言应用可以根据自己的实际需求进行编写。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> <span class="operator">-e</span></span><br><span class="line"><span class="keyword">if</span> [ ! <span class="variable">$1</span> ] </span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">'no git url'</span></span><br><span class="line">	<span class="built_in">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ ! <span class="variable">$2</span> ]  </span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">'no project name'</span></span><br><span class="line">	<span class="built_in">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">TARGET_DIR=/var/www/html/<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#init</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="operator">-d</span> <span class="variable">$TARGET_DIR</span> ] </span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">'clean dir'</span></span><br><span class="line">	sudo rm -rf <span class="variable">$TARGET_DIR</span></span><br><span class="line">	sudo mkdir -p <span class="variable">$TARGET_DIR</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">'create dir'</span></span><br><span class="line">	sudo mkdir -p <span class="variable">$TARGET_DIR</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#git clone</span></span><br><span class="line">sudo git <span class="built_in">clone</span> <span class="variable">$1</span> <span class="variable">$TARGET_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'success'</span></span><br></pre></td></tr></table></figure>
<p>写完之后我们在Git@OSC的管理界面进行设置。<br><img src="/img/git_osc_hook.jpg" alt="git_osc_hook.jpg"></p>
<p>然后自己的项目也可以享受git push，然后自动发布的快感了。</p>
<hr>
<p>下面是今天碰到的一些问题和解决方法。</p>
<blockquote>
<p>exec()执行外部linux脚本问题及解决</p>
</blockquote>
<p>首先碰到的问题是exec()函数无法执行的问题，因为php.ini默认是没有开启这个函数的，需要我们去修改配置文件（如果不知道php配置文件在哪里请用phpinfo()查看）。然后再php.ini中会会有一个disable_functions，把后面的pcntl_exec删掉就可以了。</p>
<p>启用了exec()，这下应该能用了吧？想太多了，还有坑呢。因为我们执行一些命令的时候权限不够。这时候首先来查看apache的执行用户是谁，sudo lsof -i:80<br><img src="/img/lsof-i.jpg" alt="lsof-i.jpg"></p>
<p>我们看到是一个叫做www-data的用户，为了让这个用户能够享用使用sudo而不需要密码的权利我们需要配置一下sudoers，sudo vim /etc/sudoers，在文件中加入下面的语句即可。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www-data ALL=(ALL:ALL) NOPASSWD:ALL</span><br></pre></td></tr></table></figure></p>
<p>必要的时候还需要注释掉 default requiretty 。</p>
<p>上面的操作完成之后应该就可以使用exec()执行linux命令了，然后我碰到了一个很有意思的问题，就是在前面提到的重定向权限不够的问题。比如执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">echo</span> <span class="string">'hi'</span> &gt;/<span class="built_in">test</span></span><br></pre></td></tr></table></figure></p>
<p>会发现提示”-bash: /test: Permission denied”，有机智的同学可能会想到’&gt;’和’&gt;&gt;’也是命令啊，他们没有root权限，确实是这样的，但是你在’&gt;’前面加一个sudo不能解决任何问题。</p>
<p>为了解决这个问题我们可以在命令中加入’sh -c’，如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="built_in">echo</span> <span class="string">'hi'</span> &gt;/<span class="built_in">test</span></span><br></pre></td></tr></table></figure></p>
<p>这样可以让sudo的权限扩展到整个语句，使得重定向符也拥有root权限。</p>
<p>另一种方法就是我使用的，使用tee指令，然后用管道符’|’链接，它和’&gt;’效果是一样的，加上参数’-a’之后和’&gt;&gt;’效果相同。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'hi'</span> |sudo tee /<span class="built_in">test</span></span><br></pre></td></tr></table></figure></p>
<hr>
<blockquote>
<p>apache2开启mod_rewrite以及使用</p>
</blockquote>
<p>开启rewrite并合理配置.htaccess之后可以让我们php项目的地址显得更加漂亮简洁，而不必去访问一个丑陋的xxx.com/xxx.php。</p>
<p>不过使用apt安装的apache时并没有默认开启rewrite module的，需要我们手动做一些配置。</p>
<p>ubuntu14.04安装apache2之后的配置文件有了些许的变化，不是往常的httpd.conf而是/etc/apache2/apache2.conf，打开之后我们发现新的配置文件已经把mods-enabled的配置放在了mods-enabled的目录下，里面都是从mods-available目录下面拉过来的软链接，我们只需要<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln <span class="operator">-s</span> ../mods-available/rewrite.load</span><br></pre></td></tr></table></figure></p>
<p>即可。或者图简单可以直接在apache2.conf中添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LoadModule rewrite_module /usr/lib/apache2/modules/mod_rewrite.so</span><br></pre></td></tr></table></figure></p>
<p>然后将目录设置下的AllowOverride None改为AllowOverride ALL，我们的rewrite就可以真正生效了（不要忘记重启apache）。<br>一条典型的rewrite应该放在根目录的.htaccess文件中,下面这一条实现了匹配所有/share/xxx的地址到share.php?topicId=$1去的需求。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RewriteEngine on                      &#10;RewriteRule ^/?share/([a-zA-Z0-9_-]+)$ share.php?topicId=$1</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xlvecle.github.io/2015/04/22/利用Git-OSC提供的hook实现自动化部署/" data-id="cikj3p0zu000djpxbwnvibme1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/10/04/解决升级El Capitain后开发环境乱套的问题/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          解决升级El Capitain后开发环境乱套的问题
        
      </div>
    </a>
  
  
    <a href="/2015/04/21/使用php请求api/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">使用php请求api</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <!-- 多说评论框 start -->
  <div class="ds-thread" data-thread-key="post-利用Git-OSC提供的hook实现自动化部署" data-title="利用Git@OSC提供的hook实现自动化部署" data-url="http://xlvecle.github.io/2015/04/22/利用Git-OSC提供的hook实现自动化部署/"></div>
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <script type="text/javascript">
  var duoshuoQuery = {short_name:'xlvecle'};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] 
       || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
  <!-- 多说公共JS代码 end -->
</section>
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 xlvecle<br>
      <a href="https://github.com/steven5538/hexo-theme-athena" target="_blank">Theme</a> by <a href="http://steven5538.tw" target="_blank">Steven5538</a> | Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-68563500-1', 'auto');
  ga('send', 'pageview');

</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>